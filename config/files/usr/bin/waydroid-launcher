#!/usr/bin/env bash

# shellcheck source=/dev/null
source /etc/default/waydroid-launcher

# Kill any previous remnants
if [ "$(systemctl is-active waydroid-container.service)" == 'active' ]; then
    pkexec /usr/libexec/waydroid-container-stop
fi

# Check if Waydroid is initialized, initialize if not
if grep -qz 'not initialized' <<<"$(/usr/bin/waydroid status)"; then
    /usr/bin/ujust init-waydroid
fi

pkexec /usr/libexec/waydroid-container-start

# Launch Waydroid
LAUNCH_PARAM=$@
gamescope --output-width "${WAYDROID_WIDTH:-1280}" --output-height "${WAYDROID_HEIGHT:-800}" -- /usr/bin/waydroid ${LAUNCH_PARAM:-first-launch} &

# Fix controllers, we know Waydroid has started because surfaceflinger is running
while [ "" == "$(pgrep surfaceflinger)" ]; do
    sleep 1
done
pkexec /usr/libexec/waydroid-fix-controllers

# Waydroid is now live!
# Wait for exit and then clean up
while [ -n "$(pgrep gamescope)" ]; do
    sleep 1
done

pkexec /usr/libexec/waydroid-container-stop
